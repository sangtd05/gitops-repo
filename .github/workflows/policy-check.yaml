name: Policy Check

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
    paths:
      - 'resources/**'
      - '.github/workflows/**'

jobs:
  kyverno-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Kyverno CLI
        uses: kyverno/action-install-cli@v0.2.0
        with:
          release: v1.12.0

      - name: Render Helm Charts
        run: |
          mkdir -p rendered-manifests
          find resources -name Chart.yaml | while read chart; do
            dir=$(dirname "$chart")
            echo "Rendering chart in $dir..."
            helm dependency build "$dir" || true
            helm template "$dir" >> rendered-manifests/all.yaml
            echo "---" >> rendered-manifests/all.yaml
          done

      - name: Apply Policy Check
        run: |
          echo "Checking policies against resources..."
          kyverno apply resources/policies --resource rendered-manifests/all.yaml --policy-report=true --detailed-results=true --audit-warn --warn-exit-code 0
